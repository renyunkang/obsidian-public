<!doctype html><html lang=en><head><script async defer data-website-id=08a754c4-6690-46d7-bb80-8ff93cfa232f src=https://umami.oldwinter.top/umami.js></script><meta charset=utf-8><meta name=description content="使用自定义 VPC Kube-OVN 支持多租户隔离级别的 VPC 网络。不同 VPC 网络相互独立，可以分别配置 Subnet 网段、路由策略、安全策略、出网网关、EIP 等配置。
说明  VPC 主要用于有多租户网络强隔离的场景。部分 Kubernetes 网络功能在多租户网络下存在冲突。 例如节点和 Pod 互访，NodePort 功能，基于网络访问的健康检查和 DNS 能力在多租户网络场景暂不支持。 为了方便常见 Kubernetes 的使用场景，Kube-OVN 默认 VPC 做了特殊设计，该 VPC 下的 Subnet 可以满足 Kubernetes 规范。 常见隔离需求可通过默认 VPC 下的网络策略和子网 ACL 实现 用户自定义 VPC 支持静态路由、EIP、NAT 网关等功能。 在使用自定义 VPC 前请明确是否需要 VPC 级别的隔离，并了解自定义 VPC 下的限制。  VPC 出网网关   使用自定义 vpc 并配置出口网关时，需要使用 multus-cni，因此必须安装 [[multus-cni]] 自定义 VPC 下的子网不支持默认 VPC 下的分布式网关和集中式网关。   自定义 VPC 内容器访问外部网络需要通过 VPC 网关，VPC 网关可以打通物理网络和租户网络，并提供浮动 IP、SNAT、DNAT 功能。"><title>🌿知识花园🌸</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.ryken.cloud//icon.png><link href=https://www.ryken.cloud/styles.b3e1e36b0403ac565c9392b3e23ef3b6.min.css rel=stylesheet><link href=https://www.ryken.cloud/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.ryken.cloud/js/darkmode.66c3ed4615b59e04fa897375e67b0fe2.min.js></script>
<script src=https://www.ryken.cloud/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://www.ryken.cloud/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js></script>
<script src=https://www.ryken.cloud/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://www.ryken.cloud/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://www.ryken.cloud/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://www.ryken.cloud/",fetchData=Promise.all([fetch("https://www.ryken.cloud/indices/linkIndex.c2f3b8ad0e5a97643ec7e76811d728d2.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.ryken.cloud/indices/contentIndex.00f4e4b8c237e28655637b4cda53c7d6.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://www.ryken.cloud",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.ryken.cloud",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-11MD77L81V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-11MD77L81V",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=search placeholder=支持标题及全文搜索...><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.ryken.cloud/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://www.ryken.cloud/>🌿知识花园🌸</a></h1><div class=spacer></div><div id=search-icon><p>search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>最近编辑于
Unknown</p><ul class=tags></ul><aside class=mainTOC><details><summary>目录</summary><nav id=TableOfContents><ol><li><ol><li><a href=#使用自定义-vpc>使用自定义 VPC</a></li><li><a href=#1-开启自定义vpc>1. 开启自定义VPC</a></li><li><a href=#2-创建-vpc>2. 创建 VPC</a></li><li><a href=#3--创建-eipdnatsnatfloat-ip>3. 创建 EIP、DNAT、SNAT、Float IP</a></li><li><a href=#其他>其他</a></li></ol></li></ol></nav></details></aside><a href=#使用自定义-vpc><h3 id=使用自定义-vpc><span class=hanchor arialabel=Anchor># </span>使用自定义 VPC</h3></a><p>Kube-OVN 支持多租户隔离级别的 VPC 网络。不同 VPC 网络相互独立，可以分别配置 Subnet 网段、路由策略、安全策略、出网网关、EIP 等配置。</p><a href=#说明><h5 id=说明><span class=hanchor arialabel=Anchor># </span>说明</h5></a><ul><li>VPC 主要用于有多租户网络强隔离的场景。部分 Kubernetes 网络功能在多租户网络下存在冲突。 例如节点和 Pod 互访，NodePort 功能，基于网络访问的健康检查和 DNS 能力在多租户网络场景暂不支持。 为了方便常见 Kubernetes 的使用场景，Kube-OVN 默认 VPC 做了特殊设计，该 VPC 下的 Subnet 可以满足 Kubernetes 规范。</li><li>常见隔离需求可通过默认 VPC 下的网络策略和子网 ACL 实现</li><li>用户自定义 VPC 支持静态路由、EIP、NAT 网关等功能。</li><li>在使用自定义 VPC 前请明确是否需要 VPC 级别的隔离，并了解自定义 VPC 下的限制。</li></ul><a href=#vpc-出网网关><h5 id=vpc-出网网关><span class=hanchor arialabel=Anchor># </span>VPC 出网网关</h5></a><blockquote><ol><li>使用自定义 vpc 并配置出口网关时，需要使用 multus-cni，因此必须安装 <a href=/multus-cni rel=noopener class=internal-link data-src=/multus-cni>multus-cni</a></li><li>自定义 VPC 下的子网不支持默认 VPC 下的分布式网关和集中式网关。</li></ol></blockquote><p>自定义 VPC 内容器访问外部网络需要通过 VPC 网关，VPC 网关可以打通物理网络和租户网络，并提供浮动 IP、SNAT、DNAT 功能。</p><a href=#1-开启自定义vpc><h3 id=1-开启自定义vpc><span class=hanchor arialabel=Anchor># </span>1. 开启自定义VPC</h3></a><p>启用 vpc 时，是否开启出网网关，开启出口网关时初始化出口 eip 池</p><a href=#开启出网网关><h4 id=开启出网网关><span class=hanchor arialabel=Anchor># </span>开启出网网关</h4></a><p>开启 VPC 网关功能时会在 <code>kube-system</code> 下创建 <code>ovn-vpc-nat-gw-config</code> comfigmap，并支持自定义镜像。</p><a href=#配置出网网络池><h4 id=配置出网网络池><span class=hanchor arialabel=Anchor># </span>配置出网网络池</h4></a><ul><li>创建一个 <code>name</code> 必须为 ovn-vpc-external-network 的 Subnet 用来管理可用的外部地址，请和网络管理沟通给出可用的物理段 IP</li><li>VPC 网关使用 Macvlan 做物理网络配置，需指定相应节点的物理网路网卡(所选节点应有同名的网卡)，且 VPC 网关无法与 underlay 使用同一节点的同一张网卡</li></ul><a href=#2-创建-vpc><h3 id=2-创建-vpc><span class=hanchor arialabel=Anchor># </span>2. 创建 VPC</h3></a><p>创建 vpc 网络，指定其控制的企业空间或不限定，创建<em>内部的默认子网</em>，创建出口网关</p><a href=#创建默认子网><h4 id=创建默认子网><span class=hanchor arialabel=Anchor># </span>创建默认子网</h4></a><p>该子网可以与其他 vpc 下的地址重叠</p><a href=#创建-vpc-出口网关><h4 id=创建-vpc-出口网关><span class=hanchor arialabel=Anchor># </span>创建 VPC 出口网关</h4></a><p>该网关会在 kube-system 创建一个 pod ，并使用该 vpc 创建的默认子网的最后一个地址进行分配 ip，创建完成之后会自动回填 vpc 静态路由
出口网关支持 Pod 的节点选择器，但可供选择的节点为创建出网网络池所指定的节点。
绑定 vpc ，使用子网分配地址，节点选择器</p><a href=#3--创建-eipdnatsnatfloat-ip><h3 id=3--创建-eipdnatsnatfloat-ip><span class=hanchor arialabel=Anchor># </span>3. 创建 EIP、DNAT、SNAT、Float IP</h3></a><ul><li>可以随机分配一个 eip；可以指定一个地址来分配 eip。（IptablesEIP 资源在创建时就绑定到出口网关上了，因此底层配合 vip 可以实现预留，在实际绑定时进行创建 IptablesEIP）</li><li>Float IP：表示将 eip 绑定到 内部指定的一个 pod 上</li><li>SNAT：指定某一个 internalCIDR 做 SNAT转换</li><li>DNAT：指定协议、ip、端口做DNAT转换</li></ul><p>SNAT：</p><table><thead><tr><th>字段</th><th>说明</th><th>取值</th></tr></thead><tbody><tr><td>cidr</td><td>匹配的cidr</td><td>10.0.0.0/24</td></tr><tr><td>DNAT：</td><td></td><td></td></tr><tr><td>字段</td><td>说明</td><td>取值</td></tr><tr><td>&ndash;</td><td>&ndash;</td><td>&ndash;</td></tr><tr><td>protocol</td><td>协议</td><td>tcp、udp</td></tr><tr><td>internalIP</td><td>pod ip</td><td>10.0.1.254</td></tr><tr><td>internalPort</td><td>pod port</td><td>80</td></tr><tr><td>externalPort</td><td>对外暴露的 port</td><td>80</td></tr></tbody></table><p>dnat 会转换为 iptables 规则，protocol 取值范围为 /etc/protocols 中的值，但此处只取常用的tcp 和 udp</p><a href=#其他><h3 id=其他><span class=hanchor arialabel=Anchor># </span>其他</h3></a><p><em>（为了简单化集成，可以不开放该功能点）</em></p><a href=#自定义路由><h4 id=自定义路由><span class=hanchor arialabel=Anchor># </span>自定义路由</h4></a><p>在自定义 VPC 内，用户可以自定义网络内部的路由规则，结合网关实现更灵活的转发。
Kube-OVN 支持静态路由和更为灵活的策略路由。
<strong>静态路由</strong></p><table><thead><tr><th>字段</th><th>说明</th><th>取值</th></tr></thead><tbody><tr><td>cidr</td><td>匹配的cidr</td><td>0.0.0.0/0</td></tr><tr><td>下一跳</td><td>下一跳地址</td><td>10.0.1.254</td></tr><tr><td>策略</td><td>支持目的地址路由 policyDst 和源地址路由 policySrc</td><td>policyDst、policySrc</td></tr></tbody></table><ul><li>当路由规则存在重叠时，CIDR 掩码较长的规则优先级更高，若掩码长度相同则目的地址路由优先于源地址路由。</li></ul><p><strong>策略路由</strong>
策略路由提供了更精确的匹配规则，优先级控制 和更多的转发动作。针对静态路由匹配的流量，可通过策略路由进行更细粒度的控制。</p><table><thead><tr><th>字段</th><th>说明</th><th>取值</th></tr></thead><tbody><tr><td>action</td><td>执行的动作</td><td>allow、drop、reroute</td></tr><tr><td>match</td><td>匹配的条件</td><td>符合流表的规则</td></tr><tr><td>priority</td><td>优先级</td><td>0~32767</td></tr><tr><td>nextHopIP</td><td>当action 为 reroute 时指定下一跳</td><td>10.0.1.252</td></tr></tbody></table><blockquote><p>该功能为 OVN 内部逻辑路由器策略功能的一个对外暴露，更多使用信息请参考 
<a href=https://man7.org/linux/man-pages/man5/ovn-nb.5.html#Logical_Router_Policy_TABLE rel=noopener>Logical Router Policy</a></p></blockquote><a href=#vpc-peer><h4 id=vpc-peer><span class=hanchor arialabel=Anchor># </span>VPC Peer</h4></a><p><a href=https://kube-ovn.readthedocs.io/zh_CN/latest/advance/vpc-peering/ rel=noopener>VPC 互联 - Kube-OVN 文档</a>
VPC 互联提供了一种将两个 VPC 网络通过逻辑路由打通的机制，从而使两个 VPC 内的工作负载可以像在同一个私有网络一样， 通过私有地址相互访问，无需通过外部网关进行 NAT 转发。</p><a href=#前提条件><h5 id=前提条件><span class=hanchor arialabel=Anchor># </span>前提条件</h5></a><ol><li>该功能只适用于用户自定义 VPC。</li><li>为了避免路由重叠两个 VPC 内的子网 CIDR 不能重叠。</li><li>目前只支持两个 VPC 的互联，更多组 VPC 之间的互联暂不支持。</li></ol></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>反向链接</h3><ul class=backlinks><li>未发现反向链接</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>内部链接关系图</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.ryken.cloud/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><hr><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script><script src=alittlejs/md5.min.js></script><div id=gitalk-container></div><script>var gitalk=new Gitalk({clientID:"d21f4afcd185c95004e0",clientSecret:"8f1f442abf93a76461783af21c544717da9fc7b3",repo:"obsidian-publish",owner:"renyunkang",admin:["renyunkang"],id:location.href,distractionFreeMode:!1});gitalk.render("gitalk-container")</script><center><script>var caution=!1,now,visits;function setCookie(e,t,n,s,o,a){var i=e+"="+escape(t)+(n?"; expires="+n.toGMTString():"")+(s?"; path="+s:"")+(o?"; domain="+o:"")+(a?"; secure":"");!caution||(e+"="+escape(t)).length<=4e3?document.cookie=i:confirm("Cookie exceeds 4KB and will be cut!")&&(document.cookie=i)}function getCookie(s){var e=s+"=",n,t=document.cookie.indexOf(e);return t==-1?null:(n=document.cookie.indexOf(";",t+e.length),n==-1&&(n=document.cookie.length),unescape(document.cookie.substring(t+e.length,n)))}function deleteCookie(e,t,n){getCookie(e)&&(document.cookie=e+"="+(t?"; path="+t:"")+(n?"; domain="+n:"")+"; expires=Thu, 01-Jan-70 00:00:01 GMT")}function fixDate(e){var n=new Date(0),t=n.getTime();t>0&&e.setTime(e.getTime()-t)}now=new Date,fixDate(now),now.setTime(now.getTime()+730*24*60*60*1e3),visits=getCookie("counter"),visits?visits=parseInt(visits)+1:visits=1,setCookie("counter",visits,now),document.write("<font size=2>👋访问量："+visits+"")</script></center></div></body></html>